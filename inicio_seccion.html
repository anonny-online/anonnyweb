<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Public Email Service</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
<style>
  /* —— Paleta elegante/pro —— */
  :root{
    --bg:#0b0f14;           /* fondo carbón */
    --panel:#0f141a;        /* panel principal */
    --panel-2:#121921;      /* panel secundario */
    --card:#0f1821;         /* inputs/cards */
    --text:#e6edf3;         /* texto alto contraste suave */
    --muted:#9fb0bf;        /* texto secundario */
    --border:#16222b;       /* bordes sutiles */
    --brand:#2db4a9;        /* acento turquesa sobrio */
    --brand-2:#1f7f78;      /* gradiente */
    --accent:#d7b774;       /* acento secundario dorado suave */
    --danger:#ff6a7d;       /* aviso */
    --shadow:0 18px 40px rgba(0,0,0,.45);
    --r:14px;
    --ring:0 0 0 3px rgba(45,180,169,.25);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html, body {
    height: 100%;
    width: 100%;
    overflow-x: hidden;
  }
  body{
    font-family:'Inter',system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;
    background: radial-gradient(1200px 800px at 80% -10%, rgba(77,142,255,.08), transparent 60%),
                radial-gradient(800px 600px at 10% 110%, rgba(45,180,169,.08), transparent 55%),
                var(--bg);
    color:var(--text);
    min-height:100vh;
    display:flex;
    justify-content:center;
    align-items:flex-start;
    padding:16px;
    line-height:1.5;
  }

  .container{
    width:100%;
    max-width:min(95%, 1200px);
    background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.0));
    border:1px solid var(--border);
    border-radius:22px;
    box-shadow:var(--shadow);
    overflow:hidden;
    backdrop-filter: blur(6px);
    margin:auto;
  }

  .header{
    background:linear-gradient(135deg, var(--brand), var(--brand-2));
    padding:clamp(20px, 4vw, 30px) clamp(16px, 3vw, 24px);
    text-align:center;
    border-bottom:1px solid rgba(255,255,255,.06)
  }

  .header h1{
    font-size:clamp(1.5rem, 5vw, 2.1rem);
    font-weight:800;
    margin-bottom:8px;
    letter-spacing:.2px
  }

  .header p{
    opacity:.9;
    font-size:clamp(0.9rem, 2.5vw, 1rem);
  }

  .content{
    padding:clamp(16px, 3vw, 22px)
  }

  .card{
    background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.00));
    border:1px solid var(--border);
    border-radius:14px;
    padding:clamp(14px, 3vw, 18px);
    margin-bottom:clamp(14px, 3vw, 18px)
  }

  .email-address{
    display:flex;
    align-items:center;
    gap:10px;
    justify-content:center;
    font-weight:800;
    color:#c6f5ef;
    text-shadow:0 1px 0 rgba(0,0,0,.25);
    font-size:clamp(0.9rem, 3vw, 1.1rem);
    word-break: break-all;
    text-align: center;
    padding: 0 8px;
  }

  .selects{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    margin:12px 0
  }

  select,input{
    background:var(--card);
    border:1px solid var(--border);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    width:100%;
    max-width:300px;
    font-size:clamp(0.9rem, 2.5vw, 1rem);
    transition:border-color .2s ease, box-shadow .2s ease, transform .05s ease
  }

  select:focus,input:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:var(--ring)
  }

  input:hover,select:hover{
    border-color:#1a2a34
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:8px;
    border:none;
    border-radius:12px;
    padding:12px 18px;
    font-weight:700;
    cursor:pointer;
    font-size:clamp(0.85rem, 2.5vw, 0.95rem);
    transition:transform .06s ease, filter .15s ease, box-shadow .2s ease;
    min-height:44px;
    flex:1;
    max-width:200px;
  }

  .btn:active{
    transform:translateY(1px)
  }

  .btn-brand{
    background:var(--brand);
    color:#042d2a
  }

  .btn-accent{
    background:var(--accent);
    color:#2f2817
  }

  .btn-danger{
    background:var(--danger);
    color:#2b0a12
  }

  .btn-ghost{
    background:var(--panel);
    border:1px solid var(--border);
    color:var(--text)
  }

  .btn:hover{
    filter:brightness(1.03)
  }

  .toolbar{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    justify-content:center;
    margin-top:10px
  }

  .status,.error{
    margin:10px 0;
    text-align:center;
    font-size:clamp(0.85rem, 2.5vw, 0.95rem);
    padding: 0 8px;
  }

  .status{
    color:var(--muted);
    font-weight:500
  }

  .error{
    background:var(--danger);
    color:#fff;
    padding:10px 14px;
    border-radius:12px;
    display:none
  }

  .inbox h3{
    display:flex;
    align-items:center;
    gap:8px;
    color:#c6f5ef;
    letter-spacing:.2px;
    font-size:clamp(1.1rem, 3vw, 1.3rem);
    flex-wrap: wrap;
    justify-content: center;
  }

  .email-list{
    margin-top:10px;
    max-height:50vh;
    overflow:auto;
    border:1px solid var(--border);
    border-radius:12px;
    background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.0))
  }

  .item{
    display:flex;
    justify-content:space-between;
    gap:10px;
    padding:16px;
    border-bottom:1px solid var(--border);
    cursor:pointer;
    flex-wrap: wrap;
  }

  .item:hover{
    background:rgba(255,255,255,.03)
  }

  .item:last-child{
    border-bottom:none
  }

  .preview{
    flex:1;
    min-width:200px;
    overflow:hidden
  }

  .preview strong{
    display:block;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-weight:800;
    font-size:clamp(0.9rem, 2.5vw, 1rem);
  }

  .preview small{
    color:var(--muted);
    font-size:clamp(0.8rem, 2.5vw, 0.9rem);
  }

  .time{
    color:var(--muted);
    min-width:120px;
    text-align:right;
    font-size:clamp(0.8rem, 2.5vw, 0.9rem);
    flex-shrink: 0;
  }

  .email-content{
    display:none;
    margin-top:12px;
    border:1px solid var(--border);
    border-radius:12px;
    overflow:hidden
  }

  .msg-toolbar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    padding:10px;
    background:var(--panel);
    border-bottom:1px solid var(--border)
  }

  .email-header{
    background:var(--panel);
    padding:12px;
    border-bottom:1px solid var(--border);
    font-size:clamp(0.85rem, 2.5vw, 0.95rem);
  }

  .email-body{
    padding:0;
    background:var(--panel)
  }

  .email-body iframe{
    width:100%;
    min-height:50vh;
    border:none;
    background:#fff;
    display:block
  }

  .email-body pre{
    padding:16px;
    white-space:pre-wrap;
    font-size:clamp(0.85rem, 2.5vw, 0.95rem);
    overflow-x: auto;
  }

  .attachments{
    padding:10px 12px;
    color:var(--muted);
    border-top:1px solid var(--border);
    font-size:clamp(0.85rem, 2.5vw, 0.95rem);
  }

  /* Estilos para la sección FakeXY */
  .fakexy-section {
    margin-top: 25px;
    border-top: 1px solid var(--border);
    padding-top: 20px;
  }

  .fakexy-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    color: var(--accent);
    justify-content: center;
    flex-wrap: wrap;
  }

  .fakexy-header h3 {
    font-size: clamp(1.1rem, 3vw, 1.3rem);
    margin: 0;
  }

  .fakexy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(min(100%, 250px), 1fr));
    gap: 12px;
    margin-bottom: 15px;
  }

  .fakexy-item {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px;
    display: flex;
    flex-direction: column;
  }

  .fakexy-label {
    font-size: 0.85rem;
    color: var(--muted);
    margin-bottom: 5px;
  }

  .fakexy-value {
    font-weight: 600;
    word-break: break-word;
    font-size: clamp(0.9rem, 2.5vw, 1rem);
  }

  .fakexy-buttons {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    justify-content: center;
  }

  .fakexy-copy-all {
    background: var(--accent);
    color: #2f2817;
  }

  /* Estilo para el enlace añadido */
  .fakexy-link {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    color: var(--brand);
    font-size: clamp(0.9rem, 2.5vw, 1rem);
    font-weight: 600;
    text-decoration: none;
    padding: 8px 12px;
    border-radius: 8px;
    transition: background 0.2s ease, color 0.2s ease;
  }

  .fakexy-link:hover {
    background: rgba(45, 180, 169, 0.1);
    color: var(--brand-2);
  }

  .fakexy-link i {
    font-size: 1rem;
  }

  /* Animación de carga para la bandeja de entrada */
  .loading-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    padding: 16px;
    color: var(--muted);
    font-size: clamp(0.9rem, 2.5vw, 1rem);
    background: var(--panel);
    border-radius: 12px;
    animation: fadeIn 0.3s ease-in;
  }

  .loading-icon {
    font-size: 1.5rem;
    color: var(--brand);
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  @keyframes fadeIn {
    0% { opacity: 0; transform: translateY(10px); }
    100% { opacity: 1; transform: translateY(0); }
  }

  /* Media queries para dispositivos móviles */
  @media (max-width: 768px) {
    body {
      padding: 12px;
      align-items: flex-start;
    }
    
    .container {
      border-radius: 18px;
    }
    
    .selects {
      flex-direction: column;
      align-items: center;
    }
    
    select, input {
      max-width: 100%;
    }
    
    .btn {
      max-width: 100%;
      min-width: 140px;
    }
    
    .toolbar, .fakexy-buttons {
      gap: 8px;
    }
    
    .email-list {
      max-height: 40vh;
    }
    
    .item {
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    
    .time {
      text-align: left;
      min-width: auto;
    }
    
    .preview {
      min-width: auto;
      width: 100%;
    }
    
    .email-body iframe {
      min-height: 40vh;
    }
    
    .fakexy-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (max-width: 480px) {
    body {
      padding: 8px;
    }
    
    .container {
      border-radius: 16px;
    }
    
    .header {
      padding: 16px 12px;
    }
    
    .content {
      padding: 12px;
    }
    
    .card {
      padding: 12px;
      border-radius: 12px;
    }
    
    .btn {
      padding: 10px 14px;
      font-size: 0.85rem;
    }
    
    .email-address {
      font-size: 0.9rem;
    }
    
    .toolbar, .fakexy-buttons {
      flex-direction: column;
      align-items: center;
    }
    
    .btn {
      width: 100%;
      max-width: 100%;
    }
    
    .email-list {
      max-height: 35vh;
    }
    
    .msg-toolbar {
      justify-content: center;
    }
  }

  @media (max-width: 360px) {
    .header h1 {
      font-size: 1.3rem;
    }
    
    .header p {
      font-size: 0.85rem;
    }
    
    .email-address {
      font-size: 0.85rem;
    }
    
    select, input {
      padding: 10px 12px;
    }
  }

  /* Soporte para orientación landscape en móviles */
  @media (max-height: 600px) and (orientation: landscape) {
    body {
      align-items: flex-start;
      padding: 8px;
    }
    
    .container {
      max-height: 95vh;
      overflow-y: auto;
    }
    
    .email-list {
      max-height: 30vh;
    }
    
    .email-body iframe {
      min-height: 30vh;
    }
  }

  /* Mejoras de accesibilidad */
  @media (prefers-reduced-motion: reduce) {
    * {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }

  /* Mejora de contraste para modo alto contraste */
  @media (prefers-contrast: high) {
    :root {
      --text: #ffffff;
      --muted: #cccccc;
      --border: #444444;
    }
  }
</style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1><i class="fa-solid fa-envelope-open-text"></i> Public Email Service</h1>
      <p>Secure & elegant temporary email</p>
    </div>

    <div class="content">
      <div class="card">
        <p style="text-align:center;font-weight:700">Active Email:</p>
        <div class="email-address" id="emailAddress"><i class="fa-solid fa-at"></i> No email generated yet</div>

        <div class="toolbar">
          <button class="btn btn-accent" id="copyBtn" style="display:none"><i class="fa-solid fa-copy"></i> Copy</button>
        </div>

        <div class="selects">
          <select id="providerSelect">
            <option value="mailtm" selected>Mail.tm</option>
            <option value="guerrilla">Guerrilla Mail</option>
          </select>
          <input id="emailInput" placeholder="Email Name (Mail.tm)" minlength="3" pattern="[a-zA-Z0-9._-]+"/>
          <select id="domainSelect" disabled></select>
        </div>

        <div class="toolbar">
          <button class="btn btn-brand" id="addBtn"><i class="fa-solid fa-circle-plus"></i> Add</button>
          <button class="btn btn-accent" id="autoBtn"><i class="fa-solid fa-wand-magic-sparkles"></i> Auto-Generate</button>
          <button class="btn btn-danger" id="deleteInboxBtn" style="display:none"><i class="fa-solid fa-trash"></i> Delete Inbox</button>
          <button class="btn btn-ghost" id="refreshBtn"><i class="fa-solid fa-rotate"></i> Refresh</button>
        </div>
      </div>

      <div class="status" id="status">Select a provider and generate an email.</div>
      <div class="error" id="errorMsg"></div>

      <div class="card inbox" id="inbox" style="display:none">
        <h3><i class="fa-solid fa-inbox"></i> Inbox (auto refresh 5s)
          <i class="fa-solid fa-rotate" style="cursor:pointer;margin-left:6px" id="refreshSmall"></i>
        </h3>
        <div class="loading-container" id="loading" style="display:none">
          <i class="fa-solid fa-envelope-circle-check loading-icon"></i>
          <span>Loading emails...</span>
        </div>
        <div class="email-list" id="emailList"></div>

        <div class="email-content" id="emailContent">
          <div class="msg-toolbar">
            <button class="btn btn-ghost" id="backBtn"><i class="fa-solid fa-arrow-left"></i> Back to list</button>
            <button class="btn btn-danger" id="deleteMsgBtn"><i class="fa-solid fa-trash-can"></i> Delete message</button>
          </div>
          <div class="email-header" id="emailHeader"></div>
          <div class="email-body" id="emailBody"></div>
          <div class="attachments" id="attachments" style="display:none"></div>
        </div>
      </div>
      
      <!-- Sección FakeXY API -->
      <div class="card fakexy-section" id="fakexySection">
        <div class="fakexy-header">
          <i class="fa-solid fa-user-secret"></i>
          <h3>Fake Data Generator</h3>
        </div>
        
        <div class="fakexy-grid" id="fakexyData">
          <div class="fakexy-item">
            <span class="fakexy-label">Name</span>
            <span class="fakexy-value" id="fakeName">-</span>
          </div>
          <div class="fakexy-item">
            <span class="fakexy-label">Email</span>
            <span class="fakexy-value" id="fakeEmail">-</span>
          </div>
          <div class="fakexy-item">
            <span class="fakexy-label">Phone</span>
            <span class="fakexy-value" id="fakePhone">-</span>
          </div>
          <div class="fakexy-item">
            <span class="fakexy-label">Address</span>
            <span class="fakexy-value" id="fakeAddress">-</span>
          </div>
          <div class="fakexy-item">
            <span class="fakexy-label">Company</span>
            <span class="fakexy-value" id="fakeCompany">-</span>
          </div>
          <div class="fakexy-item">
            <span class="fakexy-label">Username</span>
            <span class="fakexy-value" id="fakeUsername">-</span>
          </div>
        </div>
        
        <div style="text-align: center; margin-bottom: 15px;">
          <a href="https://www.ejemplo.com" class="fakexy-link"><i class="fa-solid fa-link"></i> Texto del enlace</a>
        </div>
        
        <div class="fakexy-buttons">
          <button class="btn btn-brand" id="generateFakeData">
            <i class="fa-solid fa-rotate"></i> Generate New Data
          </button>
          <button class="btn fakexy-copy-all" id="copyFakeData">
            <i class="fa-solid fa-copy"></i> Copy All
          </button>
        </div>
        
        <div class="status" id="fakexyStatus">Click "Generate New Data" to create fake information</div>
      </div>
    </div>
  </div>
<script>
/* ---------- Helpers ---------- */
const sleep = (ms) => new Promise(r => setTimeout(r, ms));
function showError(t) {
  const e = document.getElementById('errorMsg');
  e.textContent = t;
  e.style.display = 'block';
  setTimeout(() => e.style.display = 'none', 4500);
}
function showStatus(t) {
  document.getElementById('status').textContent = t;
}
function sanitize(s) {
  const d = document.createElement('div');
  d.textContent = String(s ?? '');
  return d.innerHTML;
}
function withTimeout(run, ms = 8000) {
  const c = new AbortController();
  const to = setTimeout(() => c.abort('timeout'), ms);
  return run(c.signal).finally(() => clearTimeout(to));
}
function disableAll(v) {
  [addBtn, autoBtn, deleteInboxBtn, refreshBtn, refreshSmall, copyBtn, deleteMsgBtn, backBtn].forEach(b => b && (b.disabled = v));
}

/* ---------- Estado ---------- */
let currentProvider = 'mailtm';
let currentEmail = null;
let currentToken = null, currentAccountId = null; // Mail.tm
let currentSidToken = null, currentSeq = 0;       // Guerrilla
let lastDomain = { mailtm: null, guerrilla: null };
let domainCursor = { mailtm: 0, guerrilla: 0 };
let intervalId = null, isLoading = false;

const usedDomains = { mailtm: new Set(), guerrilla: new Set() };
const generatedEmails = new Set(); // local parts ya usados (minúsculas)
const cache = {
  mailtmDomains: [],
  guerrillaDomains: [
    'guerrillamail.com', 'guerrillamailblock.com', 'sharklasers.com', 'grr.la',
    'guerrillamail.biz', 'guerrillamail.net', 'guerrillamail.org', 'spam4.me'
  ]
};

/* ---------- Filtros anti-bienvenida ---------- */
const welcome = {
  fromHosts: [
    'mail.tm', 'api.mail.tm', 'noreply@mail.tm', 'guerrillamail.com', 'sharklasers.com', 'grr.la',
    'guerrillamail.net', 'guerrillamail.org', 'guerrillamail.biz', 'guerrillamailblock.com', 'spam4.me'
  ],
  subjectPatterns: [
    /bienvenid[oa]/i, /welcome/i, /getting started/i, /start here/i, /confirm/i, /verify/i,
    /verificación/i, /activar/i, /activation/i, /account/i, /thanks for signing/i, /registro/i
  ],
  bodyPatterns: [
    /bienvenid[oa] a/i, /welcome to/i, /verify your email/i, /confirm your address/i,
    /activar tu cuenta/i, /activation link/i
  ]
};
function isWelcomeLike(msg) {
  const subject = (msg.subject || msg.mail_subject || '').toString();
  const fromObj = msg.from?.address || msg.from || msg.mail_from || '';
  const from = fromObj.toString();
  const html = (Array.isArray(msg.html) ? msg.html.join(' ') : (msg.html || msg.mail_body_html || '')) + '';
  const text = (msg.text || msg.mail_body || msg.textPlain || msg.intro || '') + '';

  const fromHostMatch = welcome.fromHosts.some(h => from.toLowerCase().includes(h));
  const subjMatch = welcome.subjectPatterns.some(rx => rx.test(subject));
  const bodyMatch = welcome.bodyPatterns.some(rx => rx.test(html) || rx.test(text));

  return fromHostMatch || (subjMatch && bodyMatch) || (fromHostMatch && subjMatch);
}

/* ---------- API clients ---------- */
const MailTM = {
  async domains() {
    const r = await withTimeout(s => fetch('https://api.mail.tm/domains', { signal: s }));
    const j = await r.json();
    if (!r.ok) throw new Error(`Mail.tm HTTP ${r.status}`);
    return (j['hydra:member'] || []).map(d => d.domain).filter(Boolean);
  },
  async create(address, password) {
    const r = await withTimeout(s => fetch('https://api.mail.tm/accounts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ address, password }),
      signal: s
    }));
    const j = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(j.message || `Mail.tm HTTP ${r.status}`);
    return j; // {id}
  },
  async token(address, password, tries = 6) {
    let last;
    for (let i = 0; i < tries; i++) {
      try {
        const r = await withTimeout(s => fetch('https://api.mail.tm/token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address, password }),
          signal: s
        }));
        const j = await r.json().catch(() => ({}));
        if (r.ok && j.token) return j.token;
        last = new Error(j.message || 'Invalid credentials');
      } catch (e) {
        last = e;
      }
      await sleep(250 + i * 250);
    }
    throw last || new Error('Auth failed');
  },
  async list(token) {
    const r = await withTimeout(s => fetch('https://api.mail.tm/messages', { headers: { Authorization: `Bearer ${token}` }, signal: s }));
    if (!r.ok) throw new Error(`Mail.tm HTTP ${r.status}`);
    const j = await r.json();
    return j['hydra:member'] || [];
  },
  async read(token, id) {
    const r = await withTimeout(s => fetch(`https://api.mail.tm/messages/${id}`, { headers: { Authorization: `Bearer ${token}` }, signal: s }));
    if (!r.ok) throw new Error(`Mail.tm HTTP ${r.status}`);
    return r.json();
  },
  async delAccount(id, token) {
    if (!id || !token) return;
    const r = await withTimeout(s => fetch(`https://api.mail.tm/accounts/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` },
      signal: s
    }));
    if (!r.ok && r.status !== 204) throw new Error(`Mail.tm HTTP ${r.status}`);
  },
  async delMessage(id, token) {
    const r = await withTimeout(s => fetch(`https://api.mail.tm/messages/${id}`, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${token}` },
      signal: s
    }));
    if (!r.ok && r.status !== 204) throw new Error(`Mail.tm HTTP ${r.status}`);
  }
};

const Guerrilla = {
  base: 'https://api.guerrillamail.com/ajax.php',
  async getAddress(domain) {
    const q = new URLSearchParams({ f: 'get_email_address', lang: 'en', ip: '127.0.0.1', agent: navigator.userAgent, domain: domain || '' });
    const r = await withTimeout(s => fetch(`${this.base}?${q}`, { signal: s }));
    if (!r.ok) throw new Error(`Guerrilla HTTP ${r.status}`);
    const j = await r.json();
    if (!j.email_addr || !j.sid_token) throw new Error('Guerrilla missing email/sid_token');
    return j;
  },
  async setUser(sid, email_user, domain) {
    const q = new URLSearchParams({ f: 'set_email_user', email_user, ip: '127.0.0.1', agent: navigator.userAgent, sid_token: sid, domain: domain || '' });
    const r = await withTimeout(s => fetch(`${this.base}?${q}`, { signal: s }));
    if (!r.ok) throw new Error(`Guerrilla HTTP ${r.status}`);
    const j = await r.json();
    if (!j.email_addr) throw new Error('Guerrilla did not return email');
    return j;
  },
  async list(sid, seq = 0) {
    const q = new URLSearchParams({ f: 'check_email', seq, ip: '127.0.0.1', agent: navigator.userAgent, sid_token: sid });
    const r = await withTimeout(s => fetch(`${this.base}?${q}`, { signal: s }));
    if (!r.ok) throw new Error(`Guerrilla HTTP ${r.status}`);
    const j = await r.json();
    return j.list || [];
  },
  async read(sid, id) {
    const q = new URLSearchParams({ f: 'fetch_email', email_id: id, ip: '127.0.0.1', agent: navigator.userAgent, sid_token: sid });
    const r = await withTimeout(s => fetch(`${this.base}?${q}`, { signal: s }));
    if (!r.ok) throw new Error(`Guerrilla HTTP ${r.status}`);
    return r.json();
  },
  async forget(sid) {
    const q = new URLSearchParams({ f: 'forget_me', ip: '127.0.0.1', agent: navigator.userAgent, sid_token: sid });
    await withTimeout(s => fetch(`${this.base}?${q}`, { signal: s })).catch(() => {});
  }
};

/* ---------- FakeXY API Client with Zip Codes ---------- */
const FakeXY = {
  // Lista de ciudades con códigos postales reales
  zipCodes: [
    { city: "New York", country: "USA", zip: ["10001", "10002", "10003", "10004"] },
    { city: "Los Angeles", country: "USA", zip: ["90001", "90002", "90003"] },
    { city: "Chicago", country: "USA", zip: ["60601", "60602", "60603"] },
    { city: "Houston", country: "USA", zip: ["77002", "77003", "77004"] },
    { city: "Phoenix", country: "USA", zip: ["85001", "85002", "85003"] },
    { city: "Toronto", country: "Canada", zip: ["M5V 2T6", "M4W 1A8", "M6J 1E6"] },
    { city: "London", country: "UK", zip: ["SW1A 1AA", "EC1A 1BB", "W1A 1AA"] },
    { city: "Sydney", country: "Australia", zip: ["2000", "2001", "2002"] },
    { city: "Mexico City", country: "Mexico", zip: ["06700", "03100", "01000"] },
    { city: "Madrid", country: "Spain", zip: ["28001", "28002", "28003"] }
  ],

  async generatePerson() {
    try {
      const response = await fetch('https://jsonplaceholder.typicode.com/users/' + Math.floor(Math.random() * 10 + 1));
      if (!response.ok) throw new Error('Failed to fetch user data');
      const user = await response.json();
      
      const phoneFormats = [
        `(${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
        `${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
        `+1-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`
      ];
      
      const companyNames = [
        "Acme Corp", "Globex Industries", "Stark Industries", "Wayne Enterprises", 
        "Umbrella Corp", "Cyberdyne Systems", "Oscorp", "Wonka Industries",
        "Massive Dynamic", "Initech", "Hooli", "Pied Piper"
      ];
      
      const streetNames = [
        "Main St", "Oak Ave", "Maple Dr", "Cedar Ln", "Pine St", "Elm St",
        "Washington Ave", "Park Blvd", "Lake View", "Sunset Blvd", "Broadway"
      ];
      
      // Seleccionar una ciudad con su código postal
      const cityData = this.zipCodes[Math.floor(Math.random() * this.zipCodes.length)];
      const zipCode = cityData.zip[Math.floor(Math.random() * cityData.zip.length)];
      
      return {
        name: user.name,
        email: user.email.toLowerCase(),
        phone: phoneFormats[Math.floor(Math.random() * phoneFormats.length)],
        address: `${Math.floor(Math.random() * 9999) + 1} ${streetNames[Math.floor(Math.random() * streetNames.length)]}, ${cityData.city}, ${cityData.country} ${zipCode}`,
        company: companyNames[Math.floor(Math.random() * companyNames.length)],
        username: user.username.toLowerCase()
      };
    } catch (error) {
      console.warn("API call failed, using fallback data:", error);
      return this.generateFallbackData();
    }
  },
  
  generateFallbackData() {
    const firstNames = ["James", "Mary", "John", "Patricia", "Robert", "Jennifer", "Michael", "Linda", "William", "Elizabeth"];
    const lastNames = ["Smith", "Johnson", "Williams", "Brown", "Jones", "Garcia", "Miller", "Davis", "Rodriguez", "Martinez"];
    const domains = ["gmail.com", "yahoo.com", "hotmail.com", "outlook.com", "protonmail.com"];
    const companyNames = ["Acme Corp", "Globex Industries", "Stark Industries", "Wayne Enterprises", "Umbrella Corp"];
    const streetNames = ["Main St", "Oak Ave", "Maple Dr", "Cedar Ln", "Pine St"];
    
    // Seleccionar una ciudad con su código postal
    const cityData = this.zipCodes[Math.floor(Math.random() * this.zipCodes.length)];
    const zipCode = cityData.zip[Math.floor(Math.random() * cityData.zip.length)];
    
    const firstName = firstNames[Math.floor(Math.random() * firstNames.length)];
    const lastName = lastNames[Math.floor(Math.random() * lastNames.length)];
    const domain = domains[Math.floor(Math.random() * domains.length)];
    const username = (firstName.charAt(0) + lastName).toLowerCase();
    
    return {
      name: `${firstName} ${lastName}`,
      email: `${username}@${domain}`,
      phone: `(${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
      address: `${Math.floor(Math.random() * 9999) + 1} ${streetNames[Math.floor(Math.random() * streetNames.length)]}, ${cityData.city}, ${cityData.country} ${zipCode}`,
      company: companyNames[Math.floor(Math.random() * companyNames.length)],
      username: username
    };
  }
};

/* ---------- DOM ---------- */
const providerSelect = document.getElementById('providerSelect');
const domainSelect = document.getElementById('domainSelect');
const nameInput = document.getElementById('emailInput');
const addBtn = document.getElementById('addBtn');
const autoBtn = document.getElementById('autoBtn');
const deleteInboxBtn = document.getElementById('deleteInboxBtn');
const refreshBtn = document.getElementById('refreshBtn');
const refreshSmall = document.getElementById('refreshSmall');
const copyBtn = document.getElementById('copyBtn');
const backBtn = document.getElementById('backBtn');
const deleteMsgBtn = document.getElementById('deleteMsgBtn');

// Elementos FakeXY
const generateFakeDataBtn = document.getElementById('generateFakeData');
const copyFakeDataBtn = document.getElementById('copyFakeData');
const fakexyStatus = document.getElementById('fakexyStatus');

/* ---------- Init ---------- */
window.addEventListener('load', async () => {
  await loadDomains();
  showStatus('Ready to generate your first temporary email.');
  document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible' && currentEmail) loadEmails(false);
  });
  
  // Generar datos falsos iniciales
  generateFakeData();
});
providerSelect.addEventListener('change', async () => {
  currentProvider = providerSelect.value;
  nameInput.placeholder = 'Email Name (' + (currentProvider === 'mailtm' ? 'Mail.tm' : 'Guerrilla') + ')';
  await loadDomains();
  showStatus(`Switched to ${currentProvider.toUpperCase()}.`);
});
copyBtn.addEventListener('click', async () => {
  if (!currentEmail) return;
  try {
    await navigator.clipboard.writeText(currentEmail);
    showStatus('Copied!');
  } catch {
    showError('Clipboard not available');
  }
});
backBtn.addEventListener('click', () => {
  document.getElementById('emailContent').style.display = 'none';
  document.getElementById('emailList').scrollIntoView({ behavior: 'smooth', block: 'start' });
});
deleteMsgBtn.addEventListener('click', async () => {
  const id = deleteMsgBtn.dataset.id;
  if (!id) return;
  if (currentProvider !== 'mailtm') {
    showError('Delete not available on Guerrilla.');
    return;
  }
  try {
    disableAll(true);
    await MailTM.delMessage(id, currentToken);
    document.getElementById('emailContent').style.display = 'none';
    await loadEmails(true);
  } catch (e) {
    showError(`Delete failed: ${e.message || e}`);
  } finally {
    disableAll(false);
  }
});

/* ---------- FakeXY Event Listeners ---------- */
generateFakeDataBtn.addEventListener('click', generateFakeData);
copyFakeDataBtn.addEventListener('click', copyFakeDataToClipboard);

/* ---------- FakeXY Functions ---------- */
async function generateFakeData() {
  try {
    fakexyStatus.textContent = 'Generating fake data...';
    generateFakeDataBtn.disabled = true;
    
    const fakeData = await FakeXY.generatePerson();
    
    // Actualizar la UI con los datos generados
    document.getElementById('fakeName').textContent = fakeData.name;
    document.getElementById('fakeEmail').textContent = fakeData.email;
    document.getElementById('fakePhone').textContent = fakeData.phone;
    document.getElementById('fakeAddress').textContent = fakeData.address;
    document.getElementById('fakeCompany').textContent = fakeData.company;
    document.getElementById('fakeUsername').textContent = fakeData.username;
    
    fakexyStatus.textContent = 'Fake data generated successfully!';
  } catch (error) {
    fakexyStatus.textContent = 'Error generating fake data: ' + error.message;
    console.error('FakeXY Error:', error);
  } finally {
    generateFakeDataBtn.disabled = false;
  }
}

async function copyFakeDataToClipboard() {
  try {
    const fakeData = {
      name: document.getElementById('fakeName').textContent,
      email: document.getElementById('fakeEmail').textContent,
      phone: document.getElementById('fakePhone').textContent,
      address: document.getElementById('fakeAddress').textContent,
      company: document.getElementById('fakeCompany').textContent,
      username: document.getElementById('fakeUsername').textContent
    };
    
    const textToCopy = `Name: ${fakeData.name}
Email: ${fakeData.email}
Phone: ${fakeData.phone}
Address: ${fakeData.address}
Company: ${fakeData.company}
Username: ${fakeData.username}`;
    
    await navigator.clipboard.writeText(textToCopy);
    fakexyStatus.textContent = 'All data copied to clipboard!';
    
    // Feedback visual
    copyFakeDataBtn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
    setTimeout(() => {
      copyFakeDataBtn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy All';
    }, 2000);
  } catch (error) {
    fakexyStatus.textContent = 'Failed to copy to clipboard';
    console.error('Copy error:', error);
  }
}

/* ---------- Domains ---------- */
async function loadDomains() {
  domainSelect.innerHTML = '';
  domainSelect.disabled = false;
  try {
    let list = [];
    if (currentProvider === 'mailtm') {
      if (!cache.mailtmDomains.length) cache.mailtmDomains = await MailTM.domains();
      list = cache.mailtmDomains.slice();
    } else {
      list = cache.guerrillaDomains.slice();
    }

    if (lastDomain[currentProvider]) {
      const ld = lastDomain[currentProvider];
      list = list.filter(d => d !== ld).concat(ld); // mueve el último al final
    }
    list.forEach(d => {
      const o = document.createElement('option');
      o.value = d;
      o.textContent = d;
      domainSelect.appendChild(o);
    });
    domainCursor[currentProvider] %= list.length || 1;
    domainSelect.value = list[domainCursor[currentProvider]] || list[0] || '';
  } catch (e) {
    showError(e.message || 'Error loading domains');
    domainSelect.disabled = true;
  }
}

/* ---------- Inbox delete ---------- */
deleteInboxBtn.addEventListener('click', async () => {
  if (!currentEmail) return;
  if (!confirm('Delete current inbox?')) return;
  disableAll(true);
  try {
    if (currentProvider === 'mailtm') await MailTM.delAccount(currentAccountId, currentToken);
    else if (currentProvider === 'guerrilla' && currentSidToken) await Guerrilla.forget(currentSidToken);
    resetInbox('Inbox deleted. Generate a new one.');
  } catch (e) {
    showError(`Delete inbox failed: ${e.message || e}`);
  } finally {
    disableAll(false);
  }
});
function resetInbox(msg) {
  if (currentEmail) {
    const lp = (currentEmail.split('@')[0] || '').toLowerCase();
    generatedEmails.delete(lp);
  }
  currentEmail = null;
  currentToken = null;
  currentAccountId = null;
  currentSidToken = null;
  currentSeq = 0;
  document.getElementById('emailAddress').innerHTML = '<i class="fa-solid fa-at"></i> Inbox deleted';
  document.getElementById('inbox').style.display = 'none';
  deleteInboxBtn.style.display = 'none';
  copyBtn.style.display = 'none';
  if (intervalId) clearInterval(intervalId);
  showStatus(msg || '');
}

/* ---------- Add (nombre propio en ambos) ---------- */
addBtn.addEventListener('click', async () => {
  if (isLoading) return;
  isLoading = true;
  disableAll(true);
  const load = document.getElementById('loading');
  load.textContent = 'Adding...';
  load.style.display = 'block';
  try {
    const userRaw = nameInput.value.trim();
    const domain = domainSelect.value;
    if (!userRaw) return showError('Ingresa un nombre');
    if (userRaw.length < 3) return showError('Mínimo 3 caracteres');
    if (!/^[a-zA-Z0-9._-]+$/.test(userRaw)) return showError('Permitido: letras, números, . _ -');
    if (!domain) return showError('Elige un dominio');

    const user = userRaw.toLowerCase();
    if (generatedEmails.has(user)) return showError('Ese nombre ya se usó en esta sesión');

    await safeDeleteCurrent();

    if (currentProvider === 'mailtm') {
      const address = (user + '@' + domain).toLowerCase();
      const pass = Math.random().toString(36).slice(2, 12);
      const acc = await MailTM.create(address, pass);
      const tok = await MailTM.token(address, pass);
      generatedEmails.add(user);
      activateEmail({ address, provider: 'mailtm', accountId: acc.id, token: tok, domain });
    } else {
      const session = await Guerrilla.getAddress(domain);
      const res = await Guerrilla.setUser(session.sid_token, user, domain);
      generatedEmails.add(user);
      activateEmail({ address: res.email_addr.toLowerCase(), provider: 'guerrilla', sid: session.sid_token, domain, seq: 0 });
    }

    startPolling();
    await loadEmails(true);
  } catch (e) {
    showError(`Add failed: ${e.message || e}`);
  } finally {
    isLoading = false;
    disableAll(false);
    document.getElementById('loading').style.display = 'none';
  }
});

/* ---------- Auto-Generate (nombre propio + anti-rep) ---------- */
autoBtn.addEventListener('click', async () => {
  if (isLoading) return;
  isLoading = true;
  disableAll(true);
  const load = document.getElementById('loading');
  load.textContent = 'Generating...';
  load.style.display = 'block';
  try {
    const res = await generateOn(currentProvider);
    if (!res.ok) {
      const other = currentProvider === 'mailtm' ? 'guerrilla' : 'mailtm';
      const res2 = await generateOn(other);
      if (!res2.ok) throw new Error(res.err || res2.err || 'Failed to generate');
      currentProvider = other;
      providerSelect.value = other;
    }
    startPolling();
    await loadEmails(true);
  } catch (e) {
    showError(`Error generating automatic email: ${e.message || e}`);
  } finally {
    isLoading = false;
    disableAll(false);
    document.getElementById('loading').style.display = 'none';
  }
});

async function generateOn(provider) {
  try {
    const all = provider === 'mailtm'
      ? (cache.mailtmDomains.length ? cache.mailtmDomains : (cache.mailtmDomains = await MailTM.domains()))
      : cache.guerrillaDomains;

    const last = lastDomain[provider];
    const ordered = all.filter(d => d !== last);
    if (last) ordered.push(last);

    domainCursor[provider] %= ordered.length || 1;
    const startIdx = domainCursor[provider];

    for (let step = 0; step < ordered.length; step++) {
      const idx = (startIdx + step) % ordered.length;
      const domain = ordered[idx];

      try {
        await safeDeleteCurrent();

        if (provider === 'mailtm') {
          let user = uniqueUsername();
          while (generatedEmails.has(user)) user = uniqueUsername();
          const address = (user + '@' + domain).toLowerCase();
          const pass = Math.random().toString(36).slice(2, 12);
          const acc = await MailTM.create(address, pass);
          const tok = await MailTM.token(address, pass);
          generatedEmails.add(user);
          activateEmail({ address, provider: 'mailtm', accountId: acc.id, token: tok, domain });
          domainCursor[provider] = idx + 1;
          return { ok: true };
        } else {
          const session = await Guerrilla.getAddress(domain);
          let user = uniqueUsername();
          while (generatedEmails.has(user)) user = uniqueUsername();
          const res = await Guerrilla.setUser(session.sid_token, user, domain);
          generatedEmails.add(user);
          activateEmail({ address: res.email_addr.toLowerCase(), provider: 'guerrilla', sid: session.sid_token, domain, seq: 0 });
          domainCursor[provider] = idx + 1;
          return { ok: true };
        }
      } catch (inner) { /* probar siguiente dominio */ }
    }
    return { ok: false, err: 'All domains failed (network/CORS)' };
  } catch (e) {
    return { ok: false, err: e.message || e };
  }
}

/* ---------- Generador de usuario único ---------- */
function uniqueUsername() {
  const syllA = ['la', 'le', 'li', 'lo', 'lu', 'ka', 'ke', 'ki', 'ko', 'ku', 'sa', 'se', 'si', 'so', 'su', 'ra', 're', 'ri', 'ro', 'ru', 'ta', 'te', 'ti', 'to', 'tu', 'na', 'ne', 'ni', 'no', 'nu'];
  const syllB = ['mar', 'sol', 'zen', 'lum', 'dor', 'val', 'nor', 'ver', 'tal', 'mon', 'rin', 'fin', 'cal', 'vex', 'tar', 'lin', 'min', 'ban'];
  let name = '';
  for (let i = 0; i < 3; i++) name += syllA[Math.floor(Math.random() * syllA.length)];
  name += syllB[Math.floor(Math.random() * syllB.length)];
  const suffix = Math.random().toString(36).slice(2, 6) + Date.now().toString(36).slice(-3);
  let candidate = (name + suffix).replace(/[^a-z0-9]/gi, '').toLowerCase();
  while (generatedEmails.has(candidate)) candidate += Math.random().toString(36).slice(2, 3);
  return candidate;
}

/* ---------- Limpieza segura de la bandeja actual ---------- */
async function safeDeleteCurrent() {
  if (!currentEmail) return;
  try {
    if (currentProvider === 'mailtm' && currentAccountId && currentToken) await MailTM.delAccount(currentAccountId, currentToken);
    else if (currentProvider === 'guerrilla' && currentSidToken) await Guerrilla.forget(currentSidToken);
  } catch (_) {}
}

/* ---------- Activación de la nueva cuenta ---------- */
function activateEmail({ address, provider, accountId, token, domain, sid, seq }) {
  currentProvider = provider;
  providerSelect.value = provider;
  currentEmail = address;
  currentAccountId = accountId || null;
  currentToken = token || null;
  currentSidToken = sid || null;
  currentSeq = seq || 0;
  lastDomain[provider] = domain;
  usedDomains[provider].add(domain);
  domainSelect.value = domain;
  document.getElementById('emailAddress').innerHTML = `<i class="fa-solid fa-at"></i> <span style="color:#c6f5ef">${sanitize(address)}</span>`;
  document.getElementById('inbox').style.display = 'block';
  deleteInboxBtn.style.display = 'inline-flex';
  copyBtn.style.display = 'inline-flex';
  showStatus(`Active: ${address} (${provider.toUpperCase()})`);
}

/* ---------- List / Read (+ filtro anti-bienvenida) ---------- */
refreshBtn.addEventListener('click', () => loadEmails(true));
refreshSmall.addEventListener('click', () => loadEmails(true));

async function loadEmails(manual = false) {
  if (!currentEmail) return;
  if (isLoading) return;
  if (currentProvider === 'mailtm' && !currentToken) return;
  if (currentProvider === 'guerrilla' && !currentSidToken) return;

  isLoading = true;
  const loading = document.getElementById('loading');
  loading.textContent = manual ? 'Refreshing...' : 'Updating...';
  loading.style.display = 'block';

  try {
    let msgs = [];
    if (currentProvider === 'mailtm') {
      msgs = await MailTM.list(currentToken);

      // Filtra y elimina automáticamente los "welcome" de Mail.tm
      const toDelete = [];
      msgs = msgs.filter(m => {
        const unwanted = isWelcomeLike(m);
        if (unwanted && m.id) toDelete.push(m.id);
        return !unwanted;
      });
      for (const id of toDelete) {
        try {
          await MailTM.delMessage(id, currentToken);
        } catch (_) {}
      }
    } else {
      msgs = await Guerrilla.list(currentSidToken, currentSeq);
      if (msgs.length > 0) currentSeq = msgs[0].mail_id;

      // En Guerrilla los ocultamos si parecen bienvenida
      msgs = msgs.filter(m => !isWelcomeLike(m));
    }

    const list = document.getElementById('emailList');
    list.innerHTML = '';
    if (!msgs.length) {
      list.innerHTML = '<div class="item"><div class="preview"><strong>No emails yet</strong><small>Use your address on a site to receive messages.</small></div></div>';
    } else {
      msgs.slice().reverse().forEach(m => {
        const id = m.id || m.mail_id;
        const subject = m.subject || m.mail_subject || '(No subject)';
        const from = (m.from && (m.from.address || m.from)) || m.mail_from || 'Unknown';
        const ts = (m.createdAt && Date.parse(m.createdAt)) || (typeof m.mail_timestamp === 'number' ? m.mail_timestamp * 1000 : Date.now());
        const time = new Date(ts).toLocaleString(navigator.language || 'en-US');
        const row = document.createElement('div');
        row.className = 'item';
        row.onclick = () => showEmail(id);
        row.innerHTML = `<div class="preview"><strong><i class="fa-solid fa-envelope"></i> ${sanitize(subject)}</strong><small>From: ${sanitize(from)}</small></div><div class="time">${sanitize(time)}</div>`;
        list.appendChild(row);
      });
    }
  } catch (e) {
    showError(`Load failed: ${e.message || e}`);
  } finally {
    isLoading = false;
    document.getElementById('loading').style.display = 'none';
  }
}

async function showEmail(id) {
  try {
    let msg = {};
    if (currentProvider === 'mailtm') msg = await MailTM.read(currentToken, id);
    else msg = await Guerrilla.read(currentSidToken, id);

    // Si (por timing) alguno de los no deseados se abre, se evita mostrarlo
    if (isWelcomeLike(msg)) {
      if (currentProvider === 'mailtm') {
        try {
          await MailTM.delMessage(id, currentToken);
        } catch (_) {}
      }
      showStatus('A system message was suppressed.');
      document.getElementById('emailContent').style.display = 'none';
      await loadEmails(true);
      return;
    }

    const subject = msg.subject || msg.mail_subject || '(No subject)';
    const from = (msg.from && (msg.from.address || msg.from)) || msg.mail_from || 'Unknown';
    const ts = (msg.createdAt && Date.parse(msg.createdAt)) || (typeof msg.mail_timestamp === 'number' ? m.mail_timestamp * 1000 : Date.now());
    const time = new Date(ts).toLocaleString(navigator.language || 'en-US');

    document.getElementById('emailHeader').innerHTML =
      `<strong>Subject:</strong> ${sanitize(subject)}<br><strong>From:</strong> ${sanitize(from)}<br><strong>Date:</strong> ${sanitize(time)}`;
    deleteMsgBtn.dataset.id = id;

    const bodyEl = document.getElementById('emailBody');
    bodyEl.innerHTML = '';
    const attachEl = document.getElementById('attachments');
    attachEl.style.display = 'none';
    attachEl.innerHTML = '';

    const html = (Array.isArray(msg.html) && msg.html[0]) || msg.html || msg.mail_body_html || null;
    const text = msg.text || msg.mail_body || msg.textPlain || msg.intro || '';

    if (html && /<[^>]+>/.test(String(html))) {
      const iframe = document.createElement('iframe');
      iframe.setAttribute('sandbox', '');
      iframe.srcdoc = String(html);
      bodyEl.appendChild(iframe);
    } else {
      const pre = document.createElement('pre');
      pre.textContent = String(text || '(No content)');
      bodyEl.appendChild(pre);
    }

    const atts = msg.attachments || msg.files || [];
    if (Array.isArray(atts) && atts.length) {
      attachEl.style.display = 'block';
      attachEl.innerHTML = '<strong>Attachments:</strong> ' + atts.map(a => sanitize(a.filename || a.name || 'file')).join(', ');
    }

    document.getElementById('emailContent').style.display = 'block';
    document.getElementById('emailContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
  } catch (e) {
    showError(`Open failed: ${e.message || e}`);
  }
}

/* ---------- Polling ---------- */
function startPolling() {
  if (intervalId) clearInterval(intervalId);
  intervalId = setInterval(() => {
    if (document.visibilityState === 'visible') loadEmails(false);
  }, 5000);
  showStatus('Auto-refresh every 5s…');
}
</script>
</body>
</html>